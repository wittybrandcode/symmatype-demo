/**
 * SymmaType Style Manager
 * ุฅุฏุงุฑุฉ ุงูุฃููุงุท - ุงูุชุฑููุฒ ุนูู ุงุณุชุจุฏุงู ุงูุฃููุงุท ุงููุฏููุฉ
 */

class SytyStyleManager {
    constructor(editor) {
        this.editor = editor;
    }

    /**
     * ุชุทุจูู ููุท ูุชูุฉ ูุน ุงูุชุฑููุฒ ุนูู ุงููุต ุงููุญุฏุฏ ููุท
     */
    applyBlockStyle(styleInfo) {
        SytyCore.Debug.log(`๐ฏ ุชุทุจูู ููุท: ${styleInfo.name}`);
        
        try {
            const range = SytyCore.Selection.getCurrentRange();
            if (!range) {
                SytyCore.Debug.warn('ูุง ููุฌุฏ ุชุญุฏูุฏ - ุฅูุดุงุก ุนูุตุฑ ุฌุฏูุฏ');
                this.createNewStyledElement(styleInfo);
                return;
            }

            const selectedText = SytyCore.Selection.getSelectedText();
            
            if (selectedText && selectedText.trim()) {
                // ุชุทุจูู ุงูููุท ุนูู ุงููุต ุงููุญุฏุฏ ููุท
                this.applyStyleToSelectedText(range, styleInfo, selectedText);
            } else {
                // ุชุทุจูู ุงูููุท ุนูู ุงูุนูุตุฑ ุงูุญุงูู
                this.applyStyleToCurrentElement(range, styleInfo);
            }
            
            SytyCore.Debug.log(`โ ุชู ุชุทุจูู ุงูููุท ุจูุฌุงุญ`);
            
        } catch (error) {
            SytyCore.Debug.error('โ ุฎุทุฃ ูู ุชุทุจูู ุงูููุท', error);
            this.createNewStyledElement(styleInfo);
        }
    }

    /**
     * ุชุทุจูู ุงูููุท ุนูู ุงููุต ุงููุญุฏุฏ ููุท
     */
    applyStyleToSelectedText(range, styleInfo, selectedText) {
        try {
            // ุญุฐู ุงููุต ุงููุญุฏุฏ
            range.deleteContents();
            
            // ุฅูุดุงุก ุนูุตุฑ ุฌุฏูุฏ ุจุงูููุท ุงููุทููุจ
            const newElement = this.createStyledElement(styleInfo, selectedText);
            
            // ุฅุฏุฑุงุฌ ุงูุนูุตุฑ ุงูุฌุฏูุฏ
            range.insertNode(newElement);
            
            // ุชุญุฏูุฏ ุงูุนูุตุฑ ุงูุฌุฏูุฏ
            setTimeout(() => {
                SytyCore.Selection.setCursorAtEnd(newElement);
                this.addVisualEffect(newElement);
            }, 10);
            
            SytyCore.Debug.log(`โ ุชู ุชุทุจูู ุงูููุท ุนูู ุงููุต ุงููุญุฏุฏ`);
            
        } catch (error) {
            SytyCore.Debug.error('ุฎุทุฃ ูู ุชุทุจูู ุงูููุท ุนูู ุงููุต ุงููุญุฏุฏ', error);
            throw error;
        }
    }

    /**
     * ุชุทุจูู ุงูููุท ุนูู ุงูุนูุตุฑ ุงูุญุงูู
     */
    applyStyleToCurrentElement(range, styleInfo) {
        try {
            const targetElement = this.findTargetElementSafe(range);
            
            if (targetElement && targetElement !== this.editor.element) {
                const plainText = this.extractPlainTextSafe(targetElement);
                this.replaceElementSafe(targetElement, styleInfo, plainText);
            } else {
                // ุฅูุดุงุก ุนูุตุฑ ุฌุฏูุฏ ูู ุงูููุถุน ุงูุญุงูู
                const newElement = this.createStyledElement(styleInfo, 'ูุต ุฌุฏูุฏ');
                range.insertNode(newElement);
                
                setTimeout(() => {
                    SytyCore.Selection.setCursorAtEnd(newElement);
                    this.addVisualEffect(newElement);
                }, 10);
            }
            
        } catch (error) {
            SytyCore.Debug.error('ุฎุทุฃ ูู ุชุทุจูู ุงูููุท ุนูู ุงูุนูุตุฑ ุงูุญุงูู', error);
            throw error;
        }
    }

    /**
     * ุงูุจุญุซ ุนู ุงูุนูุตุฑ ุงููุณุชูุฏู ููุชุนุฏูู - ูุณุฎุฉ ุขููุฉ
     */
    findTargetElementSafe(range) {
        try {
            // ุงูุจุญุซ ุนู ุนูุตุฑ ูุชูุฉ ูุญุชูู ุนูู ุงูุชุญุฏูุฏ
            let element = SytyCore.DOM.findBlockElement(range.commonAncestorContainer, this.editor.element);
            
            if (!element) {
                element = SytyCore.DOM.findBlockElement(range.startContainer, this.editor.element);
            }
            
            // ุงูุชุฃูุฏ ูู ุฃู ุงูุนูุตุฑ ููุณ ุงููุญุฑุฑ ููุณู ูุฃูู ุตุงูุญ
            if (element === this.editor.element || !element || !element.parentNode) {
                return null;
            }
            
            return element;
        } catch (error) {
            SytyCore.Debug.error('ุฎุทุฃ ูู ุงูุจุญุซ ุนู ุงูุนูุตุฑ ุงููุณุชูุฏู', error);
            return null;
        }
    }

    /**
     * ุงุณุชุฎุฑุงุฌ ุงููุต ุงูุนุงุฏู ุจุทุฑููุฉ ุขููุฉ
     */
    extractPlainTextSafe(element) {
        try {
            if (!element) return '';
            const text = SytyCore.DOM.getPlainText(element);
            return text || 'ูุต ุฌุฏูุฏ';
        } catch (error) {
            SytyCore.Debug.error('ุฎุทุฃ ูู ุงุณุชุฎุฑุงุฌ ุงููุต', error);
            return 'ูุต ุฌุฏูุฏ';
        }
    }

    /**
     * ุงุณุชุจุฏุงู ุงูุนูุตุฑ ุจุทุฑููุฉ ุขููุฉ
     */
    replaceElementSafe(oldElement, styleInfo, plainText) {
        try {
            if (!oldElement || !oldElement.parentNode) {
                throw new Error('ุงูุนูุตุฑ ุงููุฏูู ุบูุฑ ุตุงูุญ');
            }

            // ุฅูุดุงุก ุงูุนูุตุฑ ุงูุฌุฏูุฏ
            const newElement = this.createStyledElement(styleInfo, plainText);
            
            // ุงุณุชุจุฏุงู ุงูุนูุตุฑ
            oldElement.parentNode.replaceChild(newElement, oldElement);
            
            // ูุถุน ุงููุคุดุฑ ูู ุงูุนูุตุฑ ุงูุฌุฏูุฏ
            setTimeout(() => {
                SytyCore.Selection.setCursorAtEnd(newElement);
                this.addVisualEffect(newElement);
            }, 10);
            
            SytyCore.Debug.log(`๐ ุชู ุงุณุชุจุฏุงู ุงูุนูุตุฑ ุจูุฌุงุญ`);
            
        } catch (error) {
            SytyCore.Debug.error('ุฎุทุฃ ูู ุงุณุชุจุฏุงู ุงูุนูุตุฑ', error);
            // ุฅูุดุงุก ุนูุตุฑ ุฌุฏูุฏ ูุญู ุจุฏูู
            this.createNewStyledElement(styleInfo);
        }
    }

    /**
     * ุฅุฏุฑุงุฌ ุนูุตุฑ ุฌุฏูุฏ ุจุทุฑููุฉ ุขููุฉ
     */
    insertNewElementSafe(range, styleInfo, plainText) {
        try {
            // ุญุฐู ุงููุญุชูู ุงููุญุฏุฏ ุฅู ูุฌุฏ
            if (!range.collapsed) {
                range.deleteContents();
            }
            
            // ุฅูุดุงุก ุงูุนูุตุฑ ุงูุฌุฏูุฏ
            const newElement = this.createStyledElement(styleInfo, plainText);
            
            // ุฅุฏุฑุงุฌ ุงูุนูุตุฑ ุงูุฌุฏูุฏ
            range.insertNode(newElement);
            
            // ูุถุน ุงููุคุดุฑ ูู ุงูุนูุตุฑ ุงูุฌุฏูุฏ
            setTimeout(() => {
                SytyCore.Selection.setCursorAtEnd(newElement);
                this.addVisualEffect(newElement);
            }, 10);
            
            SytyCore.Debug.log(`โ ุชู ุฅุฏุฑุงุฌ ุนูุตุฑ ุฌุฏูุฏ ุจูุฌุงุญ`);
            
        } catch (error) {
            SytyCore.Debug.error('ุฎุทุฃ ูู ุฅุฏุฑุงุฌ ุงูุนูุตุฑ ุงูุฌุฏูุฏ', error);
            // ุฅูุดุงุก ุนูุตุฑ ุฌุฏูุฏ ูุญู ุจุฏูู
            this.createNewStyledElement(styleInfo);
        }
    }

    /**
     * ุฅูุดุงุก ุนูุตุฑ ููุณู ุฌุฏูุฏ ูุญู ุจุฏูู
     */
    createNewStyledElement(styleInfo) {
        try {
            const newElement = this.createStyledElement(styleInfo, 'ูุต ุฌุฏูุฏ');
            
            // ุฅุถุงูุฉ ุงูุนูุตุฑ ูู ููุงูุฉ ุงููุญุฑุฑ
            this.editor.element.appendChild(newElement);
            
            // ูุถุน ุงููุคุดุฑ ูู ุงูุนูุตุฑ ุงูุฌุฏูุฏ
            setTimeout(() => {
                SytyCore.Selection.setCursorAtEnd(newElement);
                this.addVisualEffect(newElement);
            }, 10);
            
            SytyCore.Debug.log(`๐ ุชู ุฅูุดุงุก ุนูุตุฑ ุฌุฏูุฏ ูุญู ุจุฏูู`);
            
        } catch (error) {
            SytyCore.Debug.error('ุฎุทุฃ ูู ุฅูุดุงุก ุงูุนูุตุฑ ุงูุจุฏูู', error);
        }
    }

    /**
     * ุฅูุดุงุก ุนูุตุฑ ููุณู ุฌุฏูุฏ
     */
    createStyledElement(styleInfo, text) {
        const element = SytyCore.DOM.createElement(styleInfo.tag);
        
        // ุฅุถุงูุฉ ุงูููุงุณ ุฅุฐุง ูุฌุฏ
        if (styleInfo.className) {
            element.className = styleInfo.className;
        }
        
        // ุฅุถุงูุฉ ุงููุต ุฃู br ุฅุฐุง ูุงู ูุงุฑุบุงู
        if (text && text.trim()) {
            element.textContent = text.trim();
        } else {
            element.innerHTML = '<br>';
        }
        
        // ุฅุถุงูุฉ ุฎุตุงุฆุต ุฅุถุงููุฉ
        element.setAttribute('data-syty-style', styleInfo.name);
        element.classList.add('syty-styled');
        
        return element;
    }

    /**
     * ุงุณุชุจุฏุงู ุนูุตุฑ ุจุขุฎุฑ
     */
    replaceElement(oldElement, newElement) {
        if (oldElement.parentNode) {
            oldElement.parentNode.replaceChild(newElement, oldElement);
        }
    }

    /**
     * ุฅุฏุฑุงุฌ ุนูุตุฑ ุฌุฏูุฏ
     */
    insertNewElement(range, element) {
        // ุญุฐู ุงููุญุชูู ุงููุญุฏุฏ ุฅู ูุฌุฏ
        if (!range.collapsed) {
            range.deleteContents();
        }
        
        // ุฅุฏุฑุงุฌ ุงูุนูุตุฑ ุงูุฌุฏูุฏ
        range.insertNode(element);
    }

    /**
     * ุฅุถุงูุฉ ุชุฃุซูุฑ ุจุตุฑู ููุนูุตุฑ ุงูุฌุฏูุฏ
     */
    addVisualEffect(element) {
        element.classList.add('syty-just-applied');
        setTimeout(() => {
            element.classList.remove('syty-just-applied');
        }, 1000);
    }

    /**
     * ุฅุฒุงูุฉ ุฌููุน ุงูุชูุณููุงุช - ูุญุณู
     */
    removeAllFormatting() {
        SytyCore.Debug.log('๐งน ุฅุฒุงูุฉ ุฌููุน ุงูุชูุณููุงุช');
        
        try {
            // ุงูุชุฃูุฏ ูู ุงูุชุฑููุฒ ุนูู ุงููุญุฑุฑ
            this.editor.element.focus();
            
            const range = SytyCore.Selection.getCurrentRange();
            if (!range) {
                SytyCore.Messages.warning('ูุง ููุฌุฏ ุชุญุฏูุฏ');
                return;
            }

            const selectedText = SytyCore.Selection.getSelectedText();
            
            if (selectedText && selectedText.trim()) {
                // ุฅุฒุงูุฉ ุชูุณูู ุงููุต ุงููุญุฏุฏ ุจุทุฑููุฉ ูุญุณูุฉ
                this.removeSelectionFormattingAdvanced(range, selectedText);
            } else {
                // ุฅุฒุงูุฉ ุชูุณูู ุงูุนูุตุฑ ุงูุญุงูู ุจุทุฑููุฉ ูุญุณูุฉ
                this.removeElementFormattingAdvanced(range);
            }
        } catch (error) {
            SytyCore.Debug.error('ุฎุทุฃ ูู ุฅุฒุงูุฉ ุงูุชูุณูู', error);
            // ุทุฑููุฉ ุจุฏููุฉ
            try {
                document.execCommand('removeFormat');
                SytyCore.Messages.success('ุชู ุฅุฒุงูุฉ ุงูุชูุณูู');
            } catch (e) {
                SytyCore.Messages.error('ูุดู ูู ุฅุฒุงูุฉ ุงูุชูุณูู');
            }
        }
    }

    /**
     * ุฅุฒุงูุฉ ุชูุณูู ุงููุต ุงููุญุฏุฏ - ูุณุฎุฉ ูุญุณูุฉ
     */
    removeSelectionFormattingAdvanced(range, selectedText) {
        try {
            // ุญุฐู ุงููุญุชูู ุงููุญุฏุฏ
            range.deleteContents();
            
            // ุฅูุดุงุก ุนูุฏุฉ ูุต ุนุงุฏูุฉ
            const textNode = document.createTextNode(selectedText);
            range.insertNode(textNode);
            
            // ุฅูุดุงุก ูุทุงู ุฌุฏูุฏ ูุชุญุฏูุฏ ุงููุต ุงููุฏุฑุฌ
            const newRange = document.createRange();
            newRange.selectNodeContents(textNode);
            
            // ุชุทุจูู ุงูุชุญุฏูุฏ ุงูุฌุฏูุฏ
            const selection = SytyCore.Selection.getCurrent();
            selection.removeAllRanges();
            selection.addRange(newRange);
            
            SytyCore.Debug.log('โ ุชู ุฅุฒุงูุฉ ุชูุณูู ุงููุต ุงููุญุฏุฏ ุจุทุฑููุฉ ูุญุณูุฉ');
            SytyCore.Messages.success('ุชู ุฅุฒุงูุฉ ุชูุณูู ุงููุต ุงููุญุฏุฏ');
            
        } catch (error) {
            SytyCore.Debug.error('ุฎุทุฃ ูู ุฅุฒุงูุฉ ุชูุณูู ุงููุต ุงููุญุฏุฏ', error);
            // ุทุฑููุฉ ุจุฏููุฉ
            try {
                document.execCommand('removeFormat');
                SytyCore.Messages.success('ุชู ุฅุฒุงูุฉ ุงูุชูุณูู');
            } catch (e) {
                SytyCore.Messages.error('ูุดู ูู ุฅุฒุงูุฉ ุงูุชูุณูู');
            }
        }
    }

    /**
     * ุฅุฒุงูุฉ ุชูุณูู ุงูุนูุตุฑ ุงูุญุงูู - ูุณุฎุฉ ูุญุณูุฉ
     */
    removeElementFormattingAdvanced(range) {
        try {
            const element = this.findTargetElementSafe(range);
            if (!element || element === this.editor.element) {
                // ุฅุฐุง ูู ููุฌุฏ ุนูุตุฑ ูุญุฏุฏุ ุงุณุชุฎุฏู removeFormat ุงูุนุงุฏู
                document.execCommand('removeFormat');
                SytyCore.Messages.success('ุชู ุฅุฒุงูุฉ ุงูุชูุณูู');
                return;
            }
            
            const plainText = this.extractPlainTextSafe(element);
            
            // ุฅูุดุงุก ููุฑุฉ ุนุงุฏูุฉ ุฌุฏูุฏุฉ
            const newP = SytyCore.DOM.createElement('p');
            
            if (plainText && plainText.trim()) {
                newP.textContent = plainText.trim();
            } else {
                newP.innerHTML = '<br>';
            }
            
            // ุงุณุชุจุฏุงู ุงูุนูุตุฑ ุจุทุฑููุฉ ุขููุฉ
            if (element.parentNode) {
                element.parentNode.replaceChild(newP, element);
                
                // ูุถุน ุงููุคุดุฑ ูู ุงูููุฑุฉ ุงูุฌุฏูุฏุฉ
                setTimeout(() => {
                    SytyCore.Selection.setCursorAtEnd(newP);
                }, 10);
                
                SytyCore.Debug.log('โ ุชู ุฅุฒุงูุฉ ุชูุณูู ุงูุนูุตุฑ ุจุทุฑููุฉ ูุญุณูุฉ');
                SytyCore.Messages.success('ุชู ุฅุฒุงูุฉ ุชูุณูู ุงูุนูุตุฑ');
            }
            
        } catch (error) {
            SytyCore.Debug.error('ุฎุทุฃ ูู ุฅุฒุงูุฉ ุชูุณูู ุงูุนูุตุฑ', error);
            // ุทุฑููุฉ ุจุฏููุฉ
            document.execCommand('removeFormat');
            SytyCore.Messages.success('ุชู ุฅุฒุงูุฉ ุงูุชูุณูู');
        }
    }

    /**
     * ุชูุธูู ุดุงูู ูููุญุฑุฑ
     */
    cleanupEditor() {
        SytyCore.Debug.log('๐งฝ ุชูุธูู ุดุงูู ูููุญุฑุฑ');
        
        // ุฅุฒุงูุฉ ุงูุนูุงุตุฑ ุงููุงุฑุบุฉ
        this.removeEmptyElements();
        
        // ุฏูุฌ ุงูุนูุฏ ุงููุตูุฉ ุงููุชุฌุงูุฑุฉ
        this.mergeAdjacentTextNodes();
        
        // ุชูุธูู ุงูููุงุณุงุช ุบูุฑ ุงููุณุชุฎุฏูุฉ
        this.cleanupUnusedClasses();
    }

    /**
     * ุฅุฒุงูุฉ ุงูุนูุงุตุฑ ุงููุงุฑุบุฉ
     */
    removeEmptyElements() {
        const emptyElements = this.editor.element.querySelectorAll('*:empty:not(br):not(img):not(hr)');
        emptyElements.forEach(element => {
            if (element.parentNode) {
                element.parentNode.removeChild(element);
            }
        });
    }

    /**
     * ุฏูุฌ ุงูุนูุฏ ุงููุตูุฉ ุงููุชุฌุงูุฑุฉ
     */
    mergeAdjacentTextNodes() {
        const walker = document.createTreeWalker(
            this.editor.element,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );
        
        const textNodes = [];
        let node;
        while (node = walker.nextNode()) {
            textNodes.push(node);
        }
        
        textNodes.forEach(textNode => {
            const nextSibling = textNode.nextSibling;
            if (nextSibling && nextSibling.nodeType === Node.TEXT_NODE) {
                textNode.textContent += nextSibling.textContent;
                nextSibling.parentNode.removeChild(nextSibling);
            }
        });
    }

    /**
     * ุชูุธูู ุงูููุงุณุงุช ุบูุฑ ุงููุณุชุฎุฏูุฉ
     */
    cleanupUnusedClasses() {
        const elements = this.editor.element.querySelectorAll('*[class]');
        elements.forEach(element => {
            // ุฅุฒุงูุฉ ุงูููุงุณุงุช ุงููุงุฑุบุฉ
            if (!element.className.trim()) {
                element.removeAttribute('class');
            }
            
            // ุฅุฒุงูุฉ ุงูููุงุณุงุช ุงูููุฑุฑุฉ
            const classes = Array.from(element.classList);
            const uniqueClasses = [...new Set(classes)];
            if (classes.length !== uniqueClasses.length) {
                element.className = uniqueClasses.join(' ');
            }
        });
    }

    /**
     * ุงูุญุตูู ุนูู ูุนูููุงุช ุงูููุท ุงูุญุงูู
     */
    getCurrentStyleInfo() {
        const range = SytyCore.Selection.getCurrentRange();
        if (!range) return null;
        
        const element = this.findTargetElement(range);
        if (!element) return null;
        
        return {
            tag: element.tagName,
            className: SytyCore.Styles.getSytyClasses(element)[0] || '',
            text: SytyCore.DOM.getPlainText(element),
            element: element
        };
    }

    /**
     * ุงูุชุญูู ูู ุฅููุงููุฉ ุชุทุจูู ููุท
     */
    canApplyStyle(styleInfo) {
        const range = SytyCore.Selection.getCurrentRange();
        return range !== null;
    }

    /**
     * ูุนุงููุฉ ุชุทุจูู ุงูููุท (ุจุฏูู ุชุทุจูู ูุนูู)
     */
    previewStyle(styleInfo) {
        const currentInfo = this.getCurrentStyleInfo();
        if (!currentInfo) return null;
        
        return {
            from: `${currentInfo.tag}${currentInfo.className ? '.' + currentInfo.className : ''}`,
            to: `${styleInfo.tag}${styleInfo.className ? '.' + styleInfo.className : ''}`,
            text: currentInfo.text
        };
    }
}

// ุชุตุฏูุฑ ุงูููุงุณ
if (typeof window !== 'undefined') {
    window.SytyStyleManager = SytyStyleManager;
} 